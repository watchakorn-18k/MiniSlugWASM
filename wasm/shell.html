<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mini Slug - HTML Port</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link
      href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        height: 100dvh;
        background-color: black;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
      }
      #game-container {
        width: 100%;
        height: 100%;
        height: 100dvh;
        max-width: 100vw;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      canvas {
        display: block;
        width: 100%;
        max-width: 100vw;
        height: auto;
        aspect-ratio: 4/3;
        object-fit: contain;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        z-index: 1;
      }
      @media (orientation: landscape) {
        canvas {
          width: auto;
          height: 100%;
          height: 100dvh;
          max-height: 100dvh;
        }
      }
      /* Mobile Touch Controls */
      #touch-controls {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 180px;
        z-index: 100;
        pointer-events: none;
        padding: 20px;
      }
      @media (pointer: coarse), (hover: none) {
        #touch-controls {
          display: flex;
          justify-content: space-between;
          align-items: flex-end;
        }
      }
      .control-btn {
        pointer-events: auto;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        background: rgba(50, 50, 50, 0.5);
        color: rgba(255, 255, 255, 0.7);
        font-family: "Roboto Mono", monospace;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        transition: transform 0.1s, background 0.1s;
        opacity: 0.5;
      }
      .control-btn:active,
      .control-btn.active {
        background: rgba(220, 38, 38, 0.6);
        transform: scale(0.95);
        opacity: 0.7;
      }
      /* D-Pad */
      #dpad {
        display: grid;
        grid-template-columns: repeat(3, 60px);
        grid-template-rows: repeat(3, 60px);
        gap: 4px;
        pointer-events: auto;
      }
      #dpad .control-btn {
        border-radius: 8px;
      }
      #dpad-up {
        grid-column: 2;
        grid-row: 1;
      }
      #dpad-left {
        grid-column: 1;
        grid-row: 2;
      }
      #dpad-right {
        grid-column: 3;
        grid-row: 2;
      }
      #dpad-down {
        grid-column: 2;
        grid-row: 3;
      }
      /* Action Buttons - Arcade Style A B C */
      #action-buttons {
        display: flex;
        gap: 16px;
        align-items: center;
        pointer-events: auto;
      }
      .action-btn {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        font-family: "Black Ops One", cursive;
        font-size: 24px;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.4), 0 6px 10px rgba(0, 0, 0, 0.3),
          inset 0 -4px 10px rgba(0, 0, 0, 0.3),
          inset 0 4px 10px rgba(255, 255, 255, 0.2);
        border: 3px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.1s, box-shadow 0.1s;
      }
      .action-btn:active,
      .action-btn.active {
        transform: translateY(4px);
        box-shadow: 0 0 0 rgba(0, 0, 0, 0.4), 0 2px 5px rgba(0, 0, 0, 0.3),
          inset 0 -2px 5px rgba(0, 0, 0, 0.3),
          inset 0 4px 10px rgba(255, 255, 255, 0.2);
      }
      #btn-a {
        background: linear-gradient(145deg, #ef4444, #b91c1c);
        border-color: #fca5a5;
        color: #fff;
      }
      #btn-b {
        background: linear-gradient(145deg, #eab308, #a16207);
        border-color: #fde047;
        color: #fff;
      }
      #btn-c {
        background: linear-gradient(145deg, #22c55e, #15803d);
        border-color: #86efac;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <!-- Canvas -->
      <canvas
        id="canvas"
        oncontextmenu="event.preventDefault()"
        tabindex="-1"
      ></canvas>
    </div>

    <!-- Mobile Touch Controls -->
    <div id="touch-controls">
      <!-- D-Pad (Left Side) -->
      <div id="dpad">
        <button id="dpad-up" class="control-btn" data-key="ArrowUp">▲</button>
        <button id="dpad-left" class="control-btn" data-key="ArrowLeft">
          ◄
        </button>
        <button id="dpad-right" class="control-btn" data-key="ArrowRight">
          ►
        </button>
        <button id="dpad-down" class="control-btn" data-key="ArrowDown">
          ▼
        </button>
      </div>

      <!-- Action Buttons (Right Side) - Arcade A B C -->
      <div id="action-buttons">
        <button id="btn-a" class="control-btn action-btn" data-key="x">
          A
        </button>
        <button id="btn-b" class="control-btn action-btn" data-key="z">
          B
        </button>
        <button id="btn-c" class="control-btn action-btn" data-key=" ">
          C
        </button>
      </div>
    </div>

    <script>
      var Module = {
        canvas: (function () {
          var canvas = document.getElementById("canvas");
          canvas.addEventListener(
            "webglcontextlost",
            function (e) {
              console.error("WebGL context lost");
              e.preventDefault();
            },
            false
          );
          canvas.addEventListener("click", function () {
            canvas.focus();
          });
          return canvas;
        })(),
        onRuntimeInitialized: function () {
          console.log("WASM Runtime Initialized");
          var canvas = document.getElementById("canvas");
          if (canvas) {
            canvas.focus();
            canvas.dispatchEvent(new MouseEvent("click", { bubbles: true }));
          }
          initTouchControls();
        },
        setStatus: function (text) {
          if (!Module.setStatus.last)
            Module.setStatus.last = { time: Date.now(), text: "" };
          if (text === Module.setStatus.last.text) return;

          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return;
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;

          console.log("Status:", text);
        },
        totalDependencies: 0,
        monitorRunDependencies: function (left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
        },
      };

      // Touch Controls Script
      function initTouchControls() {
        var canvas = document.getElementById("canvas");
        var buttons = document.querySelectorAll(".control-btn");

        function simulateKeyEvent(key, type) {
          var code;
          var keyCode;

          // Map key to correct code and keyCode
          if (key === " ") {
            code = "Space";
            keyCode = 32;
          } else if (key === "ArrowUp") {
            code = "ArrowUp";
            keyCode = 38;
          } else if (key === "ArrowDown") {
            code = "ArrowDown";
            keyCode = 40;
          } else if (key === "ArrowLeft") {
            code = "ArrowLeft";
            keyCode = 37;
          } else if (key === "ArrowRight") {
            code = "ArrowRight";
            keyCode = 39;
          } else {
            code = "Key" + key.toUpperCase();
            keyCode = key.toUpperCase().charCodeAt(0);
          }

          var event = new KeyboardEvent(type, {
            key: key,
            code: code,
            keyCode: keyCode,
            which: keyCode,
            bubbles: true,
            cancelable: true,
          });
          canvas.dispatchEvent(event);
        }

        buttons.forEach(function (btn) {
          var key = btn.getAttribute("data-key");

          btn.addEventListener(
            "touchstart",
            function (e) {
              e.preventDefault();
              btn.classList.add("active");
              simulateKeyEvent(key, "keydown");
            },
            { passive: false }
          );

          btn.addEventListener(
            "touchend",
            function (e) {
              e.preventDefault();
              btn.classList.remove("active");
              simulateKeyEvent(key, "keyup");
            },
            { passive: false }
          );

          btn.addEventListener("touchcancel", function (e) {
            btn.classList.remove("active");
            simulateKeyEvent(key, "keyup");
          });

          // Mouse events for testing on desktop
          btn.addEventListener("mousedown", function (e) {
            e.preventDefault();
            btn.classList.add("active");
            simulateKeyEvent(key, "keydown");
          });

          btn.addEventListener("mouseup", function (e) {
            btn.classList.remove("active");
            simulateKeyEvent(key, "keyup");
          });

          btn.addEventListener("mouseleave", function (e) {
            if (btn.classList.contains("active")) {
              btn.classList.remove("active");
              simulateKeyEvent(key, "keyup");
            }
          });
        });
      }

      // Initialize touch controls on load if Module hasn't initialized yet
      if (document.readyState === "complete") {
        initTouchControls();
      } else {
        window.addEventListener("load", initTouchControls);
      }
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
